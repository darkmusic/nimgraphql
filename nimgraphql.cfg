[n.global]
output = nimgraphql

[n.include]
nimgraphql/c
nimgraphql
nimgraphql/parsergen

[n.prepare]
git = "https://github.com/graphql/libgraphqlparser"

execute-win.cxx = """cmd /c cd nimgraphql\ast && python2 ast.py cxx ast.ast > ..\Ast.h"""
execute-win.cxx_impl = """cmd /c cd nimgraphql\ast && python2 ast.py cxx_impl ast.ast > ..\Ast.cpp"""
execute-win.cxx_visitor = """cmd /c cd nimgraphql\ast && python2 ast.py cxx_visitor ast.ast > ..\AstVisitor.h"""

execute-win.c = """cmd /c cd nimgraphql\ast && python2 ast.py c ast.ast > ..\c\GraphQLAst.h"""
execute-win.c_impl = """cmd /c cd nimgraphql\ast && python2 ast.py c_impl ast.ast > ..\c\GraphQLAst.cpp"""
execute-win.c_visitor_impl = """cmd /c cd nimgraphql\ast && python2 ast.py c_visitor_impl ast.ast > ..\c\GraphQLAstForEachConcreteType.h"""

execute-win.cxx_json_visitor_header = """cmd /c cd nimgraphql\ast && python2 ast.py cxx_json_visitor_header ast.ast > ..\JsonVisitor.h.inc"""
execute-win.cxx_json_visitor_impl = """cmd /c cd nimgraphql\ast && python2 ast.py cxx_json_visitor_impl ast.ast > ..\JsonVisitor.cpp.inc"""

execute-lin.cxx = """bash -c 'cd nimgraphql/ast && python2 ast.py cxx ast.ast > ../Ast.h'"""
execute-lin.cxx_impl = """bash -c 'cd nimgraphql/ast && python2 ast.py cxx_impl ast.ast > ../Ast.cpp'"""
execute-lin.cxx_visitor = """bash -c 'cd nimgraphql/ast && python2 ast.py cxx_visitor ast.ast > ../AstVisitor.h'"""

execute-lin.c = """bash -c 'cd nimgraphql/ast && python2 ast.py c ast.ast > ../c/GraphQLAst.h'"""
execute-lin.c_impl = """bash -c 'cd nimgraphql/ast && python2 ast.py c_impl ast.ast > ../c/GraphQLAst.cpp'"""
execute-lin.c_visitor_impl = """bash -c 'cd nimgraphql/ast && python2 ast.py c_visitor_impl ast.ast > ../c/GraphQLAstForEachConcreteType.h'"""

execute-lin.cxx_json_visitor_header = """bash -c 'cd nimgraphql/ast && python2 ast.py cxx_json_visitor_header ast.ast > ../JsonVisitor.h.inc'"""
execute-lin.cxx_json_visitor_impl = """bash -c 'cd nimgraphql/ast && python2 ast.py cxx_json_visitor_impl ast.ast > ../JsonVisitor.cpp.inc'"""

[n.wildcard]
wildcard.h = *.h

regex.h = """struct GraphQL([a-zA-Z]+);"""
replace.h = """struct GraphQL$1 { int dummy; };"""

wildcard.nim = *.nim

search.nim = """dummy* {.importc: "dummy".}: cint"""
replace.nim = ""

[GraphQLAst.h]
preprocess = true
defines = true

compile = GraphQLAst.cpp
compile.2 = Ast.cpp

flags = "--stdcall --prefix:GraphQL --prefix:graphql --nep1"

[GraphQLAstNode.h]
preprocess = true
defines = true

compile = GraphQLAstNode.cpp

flags = "--stdcall --prefix:GraphQL --prefix:graphql --nep1"

[GraphQLAstVisitor.h]
preprocess = true
defines = true

compile = GraphQLAstVisitor.cpp

flags = "--stdcall --prefix:GraphQL --prefix:graphql --nep1"

[GraphQLAstToJSON.h]
preprocess = true
defines = true

compile.1 = GraphQLAstToJSON.cpp
compile.2 = JsonVisitor.cpp

flags = "--stdcall --prefix:GraphQL --prefix:graphql --nep1"

[GraphQLParser.h]
preprocess = true
defines = true

compile = c/GraphQLParser.cpp
compile.2 = $output/GraphQLParser.cpp
compile.3 = """$output/parsergen/*.cpp"""

flags = "--stdcall --prefix:GraphQL --prefix:graphql --nep1"

[GraphQLAst.nim]
search = "type"
replace = ""

regex = """(?s:(\n  Ast.*?object\n))"""
move = "{.compile: \"nimgraphql/c/GraphQLAst.cpp\".}\n"

search.2 = "{.compile: \"nimgraphql/c/GraphQLAst.cpp\".}\n"
append.2 = "type\n"

[GraphQLAstToJSON.nim]
regex = """(?s:type.*?AstNode.*? = object)"""
replace = "import GraphQLAstNode"

[GraphQLParser.nim]
regex = """(?s:type.*?AstNode.*? = object)"""
replace = "import GraphQLAstNode"

[GraphQLAstVisitor.nim]
regex = """  AstNode.*? = object"""
replace = ""

search = "type"
prepend = "import GraphQLAst, GraphQLAstNode\n"

[n.sourcefile]
"$output/*.nim"

[n.post]
reset = true

execute-win.c = """cmd /c cd nimgraphql\ast && python2 ast.py c ast.ast > ..\c\GraphQLAst.h"""
execute-lin.c = """bash -c 'cd nimgraphql/ast && python2 ast.py c ast.ast > ../c/GraphQLAst.h'"""